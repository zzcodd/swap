# IPU_WEB_SERVER新增功能与权限梳理
## 目录
1. [权限管理](#权限)

2. [用户管理](#用户管理)
 
3. [录像与日志文件显示](#录像日志文件显示)

4. [录像与日志文件拷贝](#录像日志文件拷贝)

5. [状态查询](#查询状态)

6. [标定](#标定)

7. [更新](#更新)

8. [导入](#导入)

9. [总结](#总结)


## 权限
### 用户信息

| 功能  | ADMIN | CIDI |
| :--: | :--: | :--: |
| 登录 |  1  | 1 |
| 注册 |  1  | 1 |
| 删除 |  1  | 0 |
| 修改密码 |  1  | 0 |

### 录像与日志拷贝
| 功能  | ADMIN | CIDI |
| :--: | :--: | :--: |
| 录像查询| 1  |  1  |
| 录像拷贝usrdisk |  `./bag/ ./camera/full ./camera/key ` |  `./camera/full ./camera/key` |
| 录像拷贝Internaldisk |  `./bag/ ./camera/full ./camera/key `  | 0 |
| 日志拷贝usrdisk | `/ips/` `/lte/` | `/ips/` `/lte/` |
| 日志拷贝Internaldisk | `/ips/` `/lte/` | 0 |


## 用户管理
#### Handle
- 识别客户端类型：`ADMIN` `CIDI`
- 获取会话令牌：`session_token`
- 验证会话令牌：
  - 如果`令牌无效`，检查是否注册，如果未注册且不是注册指令，返回提示注册
  - 如果用户未注册是注册指令，调用Register进行注册
  - 如果用户已注册是登录指令，调用Login进行登录
- 根据客户端类型调用相应的PickHandle函数处理指令。（此处都是同一个PickHandle函数，如果后续进行权限控制，可以从这修改）
```cpp
    //处理命令
    if(CLIENT_UNKNOWN == type) {
      AINFO << "Handling as CLIENT_UNKNOWN.";
      code = PickHandle(cmd, map, out_msg);
    } else if(CLIENT_ADMIN == type) {
      AINFO << "Handling as CLIENT_ADMIN.";
      //TODO
      code = PickHandle(cmd, map, out_msg);
    } else if(CLIENT_CIDI == type) {
      AINFO << "Handling as CLIENT_CIDI.";
      //TODO
      code = PickHandle(cmd, map, out_msg);
    }
```

#### IdentifyClient
- 内置admin 为 `CLIENT_ADMIN`， 新注册的用户默认设置为 `CLIENT_CIDI`

#### Login
```Json
curl -d '{ "cmd_type": "login", "username": "cidi", "password": "c4ca4238a0b923820dcc509a6f75849b"}' http://172.16.133.63:8081/apiserver/cmd

{"data_map":{"role":"CLIENT_CIDI","session_token":"7038u795szC9R2IWF9dCC7487V5jDy4S","stream_url":"ws://svm.pingtai.cidiserver.com:41001"},"result_code":0,"result_msg":"Login successful."}
```

#### Register
```Json
curl -d '{ "cmd_type": "register", "username": "new_uesr", "password": "7096574cebeb85403bd77a8f6cbe151f","email":"test@qq.com"}' http://172.16.133.63:8081/apiserver/cmd

{"data_map":"{}","result_code":0,"result_msg":"Registration successful."}
```

#### ResetPassword
```Json
curl -d '{ "cmd_type": "reset_password", "username": "new_user", "password": "7096574cebeb85403bd77a8f6cbe151f","new_password":"21f3d99c69e2f2fe16d29a04846bc1ed" ,"email":"test@qq.com","session_token":""}' http://172.16.133.63:8081/apiserver/cmd

{"data_map":"{}","result_code":0,"result_msg":"Password has been reset successfully."}
```

#### DeleteUser
```Json
curl -d '{ "cmd_type": "delete", "username": "cidi", "password": "c4ca4238a0b923820dcc509a6f75849b","delete_username":"new_user"}' http://172.16.133.63:8081/apiserver/cmd

```

#### Logout
- 在已登录的基础上删除会话
```Json
curl -d '{ "cmd_type": "logout", "session_token":""}' http://172.16.133.63:8081/apiserver/cmd

{"data_map":"{}","result_code":0,"result_msg":"Logout successful"}
```


## 录像日志文件显示
![recordTree](https://github.com/zzcodd/ImageHosting/blob/main/record_tree.png?raw=true)

#### GetRecordDateList 和 GetLogDateList
- 列出有录像或日志文件的日期的列表
- 录像： /bag/  /camera/full/  /camera/key/
- 日志: /ips/  /lte/
  ```cpp
    函数一：0/1表示flag
    RecordLog(type, root_path, size, free_size, vec, 0);
    if (CLIENT_ADMIN == client_type) {
      RecordLog(type, root_path, size, free_size, vec, 1);
    }

    函数二：0/1表示yy
    if(flag == 1){
      GetCopyDateList(root_path + "/bag/", 0, vec);
    }
    GetCopyDateList(root_path + "/camera/full/", 0, vec);
    GetCopyDateList(root_path + "/camera/key/", 1, vec);

    函数三：
    if (1 == yy) item.type = "alarm"; 
    else item.type = "time";
  ```

#### 显示时间范围内的录像文件

- ***ShowRecordDateList***
  ：显示某一天的全部录像文件(`.avi` `.jpg`)
  ```
  curl -d '{ "cmd_type": "show_record_date_list",
  "date":"20230901"}' http://172.16.133.63:8081/apiserver/cmd

  {"data_map":{"file_count":4,"file_list":[{"file":"20230901103724228.res.avi","folder":"20230901//.res"},{"file":"20230901103724569.near.avi","folder":"20230901//6mm"},{"file":"20230901103730021.jpg","folder":"20230901//6mm"},{"file":"20230901103800014.jpg","folder":"20230901//6mm"}]},"result_code":0,"result_msg":"Query success"}
  ```

- ***ShowRecordDateListWithoutJPG***
  ：显示某一天的全部录像文件( `.avi`)

- ***ShowRecordDateListWithTimeFilter***
  : 显示某一天一个时间段的全部录像文件(`.avi` `.jpg`)
  ```
  curl -d '{ "cmd_type": "show_record_date_list_range","date":"20221215190000|20221215190200"}' http://172.16.133.63:8081/apiserver/cmd

  {"data_map":{"file_count":6,"file_list":[{"file":"20221215190029716.near.avi","folder":"20221215//6mm"},{"file":"20221215190129708.near.avi","folder":"20221215//6mm"},{"file":"20221215190000031.jpg","folder":"20221215//6mm"},{"file":"20221215190030028.jpg","folder":"20221215//6mm"},{"file":"20221215190100026.jpg","folder":"20221215//6mm"},{"file":"20221215190130024.jpg","folder":"20221215//6mm"}]},"result_code":0,"result_msg":"Query success"}
  ```

- ***ShowRecordDateListWithoutJPGWithTimeFilter***
  : 显示某一天一个时间段的全部录像文件(`.avi`)

- ***ShowLogDateList***:显示某一天的录像文件
  ```
  curl -d '{ "cmd_type": "get_log_date_list"}' http://172.16.133.63:8081/apiserver/cmd

  {"data_map":[{"name":"20240715","type":"time"},{"name":"20240716","type":"time"},{"name":"20240717","type":"time"},{"name":"20240718","type":"time"},{"name":"20240719","type":"time"},{"name":"20240720","type":"time"},{"name":"20240721","type":"time"},{"name":"20240722","type":"time"},{"name":"20240723","type":"time"},{"name":"20240724","type":"time"},{"name":"20240725","type":"time"},{"name":"20240726","type":"time"},{"name":"20240727","type":"time"},{"name":"20240728","type":"time"},{"name":"20240729","type":"time"},{"name":"20240730","type":"time"},{"name":"20240731","type":"time"},{"name":"20240801","type":"time"},{"name":"20240802","type":"time"},{"name":"20240803","type":"time"},{"name":"20240804","type":"time"},{"name":"20240805","type":"time"},{"name":"20240806","type":"time"},{"name":"20240807","type":"time"},{"name":"mcu_log","type":"time"}],"result_code":0,"result_msg":"successful"}
  ```
  
  #### 对应指令
  - HANDLE_CMD("get_record_date_list", GetRecordDateList);
  - HANDLE_CMD("get_log_date_list", GetLogDateList);
  - HANDLE_CMD("show_record_date_list", ShowRecordDateList);
  - HANDLE_CMD("show_record_date_list_noJPG"，  ShowRecordDateListWithoutJPG);
  - HANDLE_CMD("show_record_date_list_range", ShowRecordDateListWithTimeFilter);
  HANDLE_CMD("show_record_date_list_range_noJPG" ,ShowRecordDateListWithoutJPGWithTimeFilter);
  - HANDLE_CMD("show_log_date_list", ShowLogDateList);
  
## 录像日志文件拷贝
- ***RecordDateCopy*** 
  - 拷贝逻辑
    - 将单线程拷贝修改为多线程按批次拷贝，每个线程拷贝数量由`batchsize`设置
  - 拷贝权限
    - 修改`admin`身份和`cidi`的拷贝权限。且默认只拷贝`/6mm/` 和隐藏目录`/.res/` 中`.avi `和 `.mp4`结尾的数据

- ***LogDateCopy***
- ***QueryCopyProgress 和 QueryLogCopyProgress***


  #### 对应指令
  - HANDLE_CMD("record_range_copy", RecordDateCopy);
  - HANDLE_CMD("log_date_copy", LogDateCopy);
  - HANDLE_CMD("get_copy_progress", QueryCopyProgress);
  - HANDLE_CMD("get_log_copy_progress", QueryLogCopyProgress);

![Alt text](image-1.png)![Alt text](image-2.png)



## 查询状态
  权限没有区别
- 设备状态
- 传感器信息
- 内部接口信息
- 外部接口信息
- 本机版本信息

## 标定
  权限没有区别
## 更新
  权限没有区别

## 导入
  权限没有区别
- 模型导入
- 地图导入
- 参数导入

## 总结
### 已解决
- 用户信息登录注册退出等功能实现；
- 重构了录像和日志拷贝代码，拷贝的逻辑，实习的细节，内存空间的查询。在同样的拷贝任务中，（以20221215这天录像为例），拷贝时间提升了1/4；

### 遗留问题
- `admin`用户拷贝录像时，有些bag包里面的数据非常大，同时还需要拷贝`internaldisk`和`usrdisk`两份，容易出现负载过大导致服务器错误；
![Alt text](image-3.png)
  - load average: 平均负载值非常高，系统在处理大量任务。一般情况下，负载平均值超过系统CPU核心数时可能处于过载状态。
  - CPU：CPU大部分时间空闲，82.5% idle， 可能是很多I/O操作或等待中的进程导致高负载，而不是CPU密集型任务。  
- U盘离线升级完成后web页面显示接口超时

![Alt text](image-5.png)


### 更改查询拷贝进度逻辑
- 已拷贝文件数/总拷贝文件数 来描述进度
- 设置不同的interval值，优化查询时间
- 用完成进度所消耗的时间粗略估计需要拷贝完成的总时间
  - 初始是100ms
  - 大于10s 500ms
  - 大于30s 1000ms
  - 大于60s 2000ms
  ```cpp
  cidi@cidi:~/vscodeWorkspace/ipu_wbserver/ipu_web_server_arm$ curl -d '{"cmd_type":"get_copy_progress","username":"admin","password":"c4ca4238a0b923820dcc509a6f75849b"}' http://172.16.133.63:8081/apiserver/cmd

  {"data_map":  
    { 
      "copied_files":25,
      "estimated_remaining_time":16,
      "interval":500,
      "percent":62,
      "seconds":27,
      "total_files":40
    }
  ,"result_code":0,"result_msg":"正在拷贝"}
  ```